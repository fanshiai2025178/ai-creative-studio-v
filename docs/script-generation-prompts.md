# 剧本改编 API 提示词与调用逻辑文档

## 概述

剧本改编模块包含两个主要 API：
1. **generateScript** - 开始改编 / 完全重新生成
2. **optimizeScript** - AI 智能体优化

---

## 一、generateScript（开始改编 / 完全重新生成）

### 调用流程

```
用户输入（原始内容 + 高级配置）
    ↓
第一步：AI 改编优化
    ↓ 输出：改编分析 + 改编后的故事
    
第二步：AI 生成分镜脚本
    ↓ 输入：改编后的故事
    ↓ 输出：场景列表（### 场景1, ### 场景2...）
    
第三步：代码解析场景（parseAllScenes）
    ↓ 把 AI 输出的文本解析成 Scene 数组
    
第四步：代码自动分集（autoSplitEpisodes）
    ↓ 按 targetDuration（每集时长）把场景切成多集
    
第五步：构建最终剧本结构
    ↓ 输出：GeneratedScript 对象
```

### 输入参数

```typescript
{
  originalContent: string,      // 原始故事内容
  episodeCount: number,         // 集数（0 = AI 自动判断）
  durationPerEpisode: number,   // 每集时长（秒）
  storyType: string             // 故事类型
}
```

### 第一步：AI 改编优化 Prompt

```
你是专业的短剧编剧。请对以下原始素材进行【改编优化】。

【动态漫短剧的特点】
- 单集时长1-3分钟，碎片化传播
- 需要：强节奏、高张力、记忆点
- 在极短时间内抓住观众注意力

【6大核心创作要点】
1. 极致浓缩剧情：单集聚焦单一爆点，舍弃支线，用"冲突爆发—解决冲突"的极简结构
2. 强悬念与反转设计：黄金3秒开场抛出冲突/悬念，每集至少1-2个反转
3. 视觉符号强化记忆：标志性动作/道具高频出现，色彩情绪化表达
4. 台词精简到极致：字字推动剧情，对话即冲突，每句话都有力量
5. 适配碎片化观看：独立成篇+片尾钩子，用画面代替解释
6. 强化听觉记忆点：专属音效标识，音乐卡点精准

【情绪引擎七步法】
1. 黄金开局（0-30秒）：强钩子+反差人设，制造好奇与代入感
2. 意外引爆（30秒-1分钟）：金手指到账+赋予使命，打破平衡
3. 小试牛刀（1-3分钟）：首个打脸循环（憋屈→出手→打脸→收获）
4. 升级挑战（中段）：引入伙伴+树立强敌，积累仇恨
5. 绝境蜕变（高潮前奏）：压制到极限，为爆发蓄力
6. 巅峰决战（高潮）：终极打脸+身份揭露，释放爽感
7. 收尾钩子（结局）：奖励展示+新悬念，制造追看欲

【短剧主线三要素】
1. 目标明确：主角诉求要具体（如"3天内夺回公司"），避免模糊
2. 冲突集中：一个核心矛盾（主角vs反派），支线服务主线
3. 情绪锚点：绑定强烈情绪（逆袭→爽，情感→虐/甜，悬疑→好奇）

【原始素材】
${originalContent}

【创作参数】
- 故事类型：${storyType}

【你的任务】
根据以上创作要点，对原始素材进行改编优化，输出两部分内容：

===改编分析===

【主线分析】
- 主角：[谁是主角]
- 核心目标：[主角要达成什么，要具体]
- 核心冲突：[什么vs什么]
- 情绪锚点：[爽/虐/甜/好奇]

【结构规划】
- 开篇钩子：[用什么抓住观众]
- 关键反转：[设计什么反转]
- 打脸循环：[憋屈→出手→打脸→收获的设计]
- 高潮设计：[最大的爆发点]
- 结尾悬念：[留什么钩子]

【优化策略】
- 删除：[原文中与主线无关需要删除的内容]
- 强化：[需要加强的冲突/悬念]
- 新增：[原文没有但需要补充的元素]

===改编后的故事===

[在这里输出一整篇优化后的叙述文字，像小说一样。要求：
1. 应用上述所有创作要点
2. 强化冲突和悬念
3. 精简台词，字字有力
4. 节奏紧凑，删除冗余
5. 保持原作精神，但大胆创新
6. 这是故事文本，不是分镜脚本，不要包含时间码、景别、镜头标记等]

【重要】
- 这是艺术再创造，不是复制粘贴原文
- 必须严格按照上述格式输出
- "改编后的故事"必须是连贯的叙述文字，像小说一样，绝对不能包含分镜格式
- 分镜脚本将在下一步单独生成，这里只输出故事文本
- 直接开始，不要任何客套话
```

### 第二步：AI 生成分镜脚本 Prompt

```
你是专业的分镜编剧。请将以下故事转化为分镜脚本。

【故事内容】
${story}

【创作参数】
- 故事类型：${storyType}

【动态漫创作核心心法】
1. 节奏为王：拒绝任何无效文戏和慢热铺垫，每30-50秒一个情绪点，每集必须完成至少一次完整的"打脸循环"
2. 视觉化写作：你的剧本不是小说，是拍摄蓝图。写作时要同步想象画面、镜头语言。多用"瞳孔骤缩"、"拳风撕裂空间"等可视化描述
3. 台词如刀：台词要精炼、有力。主角台词宜少不宜多，用行动代替辩解。反派的台词要负责"拉仇恨"
4. "爽"是唯一真理：一切为爽感服务。逻辑可以适当为情绪让步，但情绪的流畅度和累积释放的路径绝不能断

【视觉符号强化记忆】
1. 标志性动作/道具：为主角设计专属动作（如甩发攻击）或道具（发光戒指），在每集高频出现加深印象
2. 色彩情绪化表达：用色彩暗示剧情，如危险场景以红色光影笼罩，平静时刻采用柔和蓝绿色调

【片尾钩子设计】
每集结尾必须留下强钩子，常用手法：
1. 新地图开启："蓝星已无敌，是时候去宇宙战场看看了。"
2. 更强敌人登场：一个远超本集反派的黑影在片尾现身，并对主角产生兴趣。"这只虫子，有点意思。"
3. 新危机降临："你虽赢了，但也惊醒了沉睡的古神。"

【打脸循环四步法】
每集至少完成一次完整的打脸循环：
1. 制造懋屈：小反派（如势利眼经理、同门师兄）用具体行为挑釁主角
2. 雷霆出手：主角运用金手指，用最出乎意料、最轻松的方式解决问题
3. 极致打脸：结果必须公开化，让所有旁观者震惊、反派目瞪口呆
4. 获得奖励：收获金钱、地位、美女的青睐、或解锁新技能。此奖励必须成为下一步剧情的筹码

【分镜脚本格式要求】
每个场景按以下格式输出：

### 场景1：[地点/场景名]
- 景别：[特写/近景/中景/全景/远景]
- 画面：[具体的视觉描述，要能直接用于绘制，包含色彩和光影描述]
- 动作：[角色的动作和表情，突出标志性动作]
- 台词："[对白内容，≤15字，字字有力]"
- 情绪：[情绪基调]
- 核心冲突：[这个场景的主要冲突是什么？谁vs谁，为了什么？用一句话概括]

### 场景2：[地点/场景名]
...

【分镜原则】
1. 开场必须有强钩子（黄金3秒）：悬念式/冲突式/反差式开场
2. 每个场景都要有"事件"发生，不允许空镜头
3. 台词精炼有力，每句都推动剧情或强化情感
4. 景别要有变化，避免单调
5. 情绪起伏明显，有张有弛
6. 结尾必须留强钩子（参考片尾钩子设计）

【重要】
- 直接输出分镜脚本，不要任何开场白
- 第一行必须是"### 场景1"
- 场景数量根据故事内容和情节复杂度自由决定，不要人为限制
- 每个场景的画面描述要包含色彩和光影，便于后续绘制
```

### 代码处理逻辑

#### parseAllScenes 函数
- 使用正则匹配 `### 场景X` 格式
- 提取每个场景的：景别、画面、动作、台词、情绪、核心冲突
- 返回 Scene[] 数组

#### autoSplitEpisodes 函数
- 按 targetDuration（每集时长）切分场景
- 容差范围：80% ~ 120% 的目标时长
- 自动生成每集的 coreConflict、keyEvents、hook

---

## 二、optimizeScript（AI 智能体优化）

### 调用流程

```
用户点击"AI 智能优化"
    ↓
读取当前剧本的质量评分
    ↓
根据低分项生成优化问题列表
    ↓
AI 重新生成分镜脚本（只优化分镜，保留核心冲突和关键事件）
    ↓
合并结果：新分镜 + 原有的核心冲突/关键事件
```

### 输入参数

```typescript
{
  scriptId: number,              // 剧本 ID
  originalContent: string,       // 原始内容
  durationPerEpisode?: number    // 用户当前选择的每集时长（可选）
}
```

### AI 智能优化 Prompt

```
你是专业的分镜编剧。请针对以下问题，优化分镜脚本。

【创作参数】
- 故事类型：${storyType}

【改编后的故事】
${adaptedStory}

【故事主线设定】
- 主角目标：${mainLine.goal}
- 核心矛盾：${mainLine.conflict}
- 主线描述：${mainLine.description}

【各集核心冲突与关键事件】
第1集：
  - 核心冲突：...
  - 关键事件：...
  - 黄金3秒钩子：...
第2集：
  ...

【需要改进的问题】
1. 主线清晰度不足，需要明确主角目标和核心矛盾
2. 冲突递进不够，需要让每集冲突逐步升级
...

【动态漫创作核心心法】
1. 节奏为王：拒绝任何无效文戏和慢热铺垫，每30-50秒一个情绪点
2. 视觉化写作：你的剧本不是小说，是拍摄蓝图
3. 台词如刀：台词要精炼、有力
4. "爽"是唯一真理：一切为爽感服务

【视觉符号强化记忆】
1. 标志性动作/道具
2. 色彩情绪化表达

【片尾钩子设计】
每集结尾必须留下强钩子

【打脸循环四步法】
每集至少完成一次完整的打脸循环

【优化要求】
针对上述问题，重新生成优化后的分镜脚本：
- 主线清晰度：在开场明确展示主角目标，每个场景都要推进主线
- 冲突递进：让冲突逐步升级，增加紧张感
- 节奏控制：增加场景变化，控制每个场景时长
- 台词质量：让台词更精炼有力，每句都推动剧情
- 视觉设计：增加画面描述的细节和冲击力

【分镜脚本格式】
每个场景按以下格式输出：

### 场景1：[地点/场景名]
- 景别：[特写/近景/中景/全景/远景]
- 画面：[具体的视觉描述，要能直接用于绘制，包含色彩和光影描述]
- 动作：[角色的动作和表情，突出标志性动作]
- 台词："[对白内容，≤15字，字字有力]"
- 情绪：[情绪基调]
- 音效：[环境音/配乐提示]

### 场景2：[地点/场景名]
...

【分镜原则】
1. 开场必须有强钩子（黄金3秒）
2. 每个场景都要有"事件"发生
3. 台词精炼有力
4. 景别要有变化
5. 情绪起伏明显
6. 结尾必须留强钩子

【重要】
- 直接输出分镜脚本，不要任何开场白
- 第一行必须是"### 场景1"
- 场景数量根据故事内容决定，通常10-20个场景
- 每个场景的画面描述要包含色彩和光影
```

### 代码处理逻辑

#### 保留原有核心冲突和关键事件
```typescript
const mergedEpisodes = episodes.map((newEp, idx) => {
  const originalEp = originalEpisodes[idx];
  return {
    ...newEp,
    // 保留原有的核心冲突和关键事件
    coreConflict: originalEp?.coreConflict || newEp.coreConflict,
    keyEvents: originalEp?.keyEvents || newEp.keyEvents,
    hook: originalEp?.hook || newEp.hook,
  };
});
```

---

## 三、当前问题分析

### 问题：剧情不连贯，场景/镜头衔接不上

**根本原因：**

1. **AI 生成的是"场景列表"，不是"连贯的分镜脚本"**
   - AI 输出的是一个个独立场景，没有明确的场景间衔接关系
   - 没有要求 AI 思考"上一个镜头发生了什么，下一个镜头应该怎么接"

2. **分集逻辑只看时长，不看剧情**
   - `autoSplitEpisodes` 函数只根据 `targetDuration` 来切分
   - 可能在剧情高潮中间切断，导致衔接不上

3. **缺少"镜头衔接"的明确要求**
   - Prompt 中没有要求 AI 设计镜头之间的过渡逻辑
   - 没有要求 AI 考虑时间、空间、情绪的连续性

---

## 四、建议的优化方向

### 1. 在分镜 Prompt 中增加镜头衔接要求

```
【镜头衔接原则】
1. 每个场景必须与上一个场景有明确的衔接关系
2. 衔接方式包括：
   - 时间衔接：紧接上一幕 / 几小时后 / 第二天
   - 空间衔接：同一地点 / 移动到新地点 / 对比切换
   - 情绪衔接：情绪延续 / 情绪反转 / 情绪升级
   - 因果衔接：因为上一幕的事件，所以这一幕...
3. 在每个场景开头增加"衔接"字段

【分镜脚本格式要求】
### 场景1：[地点/场景名]
- 衔接：[与上一场景的衔接关系，第一个场景写"开篇"]
- 景别：...
- 画面：...
- 动作：...
- 台词：...
- 情绪：...
- 核心冲突：...
```

### 2. 让 AI 直接输出分集剧本

在 Prompt 中告诉 AI 目标集数和每集时长，让 AI 自己决定在哪里分集：

```
【分集要求】
- 目标集数：${episodeCount} 集
- 每集时长：${durationPerEpisode} 秒
- 请在合理的剧情节点进行分集
- 每集结尾必须有钩子，开头必须承接上集

【输出格式】
## 第1集

### 场景1：...
### 场景2：...

## 第2集

### 场景3：...
...
```

### 3. 增加"剧情线索追踪"

让 AI 在生成每个场景时，追踪：
- 当前主角在做什么
- 当前冲突进展到哪一步
- 下一个场景应该推进什么

---

## 五、数据结构

### Scene 类型
```typescript
interface Scene {
  sceneId: number;
  location: string;
  characterActions: string;
  dialogue: string;
  duration: number;
  composition: string;
  emotionalTone: string;
  adaptationNote: string;
  sceneConflict?: string;
  audioDesign: {
    backgroundMusic: string;
    soundEffects: string[];
    emotionalTone: string;
  };
  visualElements: {
    colorScheme: string;
    keyObjects: string[];
    characterExpressions: string;
  };
}
```

### Episode 类型
```typescript
interface Episode {
  episodeNumber: number;
  title: string;
  duration: number;
  scenes: Scene[];
  coreConflict: string;
  keyEvents: string[];
  hook: string;
  conflictIntensity: number;
}
```

### GeneratedScript 类型
```typescript
interface GeneratedScript {
  metadata: {
    title: string;
    storyConcept: string;
    episodeCount: number;
    totalDuration: number;
    storyType: string;
    generationTimestamp: string;
    version: string;
  };
  adaptationAnalysis: string;
  adaptedStory: string;
  storyStructure: {
    mainLine: {
      description: string;
      goal: string;
      conflict: string;
    };
    structurePlan: {...};
  };
  episodes: Episode[];
  qualityMetrics: {...};
  rawContent: string;
}
```
